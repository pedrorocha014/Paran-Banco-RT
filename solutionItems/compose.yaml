version: '3.8'

services:
  postgres:
    image: postgres:16
    container_name: parana_banco_rt_db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: parana_banco_rt_db
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles: ["essentials"]

  rabbitmq:
    image: rabbitmq:3.13-management
    container_name: parana_banco_rt_rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    ports:
      - "5672:5672"    # AMQP
      - "15672:15672"  # Management UI
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    profiles: ["essentials"]

  rabbitmq-setup:
    image: curlimages/curl:8.10.1
    container_name: parana_banco_rt_rabbitmq_setup
    depends_on:
      rabbitmq:
        condition: service_healthy
    entrypoint: ["sh", "-c"]
    command: >-
      'until curl -s -u guest:guest http://rabbitmq:15672/api/healthchecks/node; do echo waiting for rabbitmq; sleep 2; done;
      curl -s -u guest:guest -H "content-type:application/json" -X PUT \
        http://rabbitmq:15672/api/queues/%2F/customer.created \
        -d "{\"auto_delete\":false,\"durable\":true,\"arguments\":{}}" && echo "customer.created queue created";
      curl -s -u guest:guest -H "content-type:application/json" -X PUT \
        http://rabbitmq:15672/api/queues/%2F/proposal.denied \
        -d "{\"auto_delete\":false,\"durable\":true,\"arguments\":{}}" && echo "proposal.denied queue created";
      curl -s -u guest:guest -H "content-type:application/json" -X PUT \
        http://rabbitmq:15672/api/queues/%2F/proposal.approved \
        -d "{\"auto_delete\":false,\"durable\":true,\"arguments\":{}}" && echo "proposal.approved queue created";
      curl -s -u guest:guest -H "content-type:application/json" -X PUT \
        http://rabbitmq:15672/api/queues/%2F/card.issue.requested \
        -d "{\"auto_delete\":false,\"durable\":true,\"arguments\":{}}" && echo "card.issue.requested queue created"'
    profiles: ["essentials"]